<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="vr-mode" content="no-vr-mode">
    <meta name="ar" content="no-ar">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
    <style>
      .zoom-controls {
        position: absolute;
        right: 20px;
        top: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .zoom-btn {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.7);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        cursor: pointer;
        user-select: none;
      }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <!-- 新增HTML縮放控制按鈕 -->
    <div class="zoom-controls">
      <div id="zoom-in-btn" class="zoom-btn">+</div>
      <div id="zoom-out-btn" class="zoom-btn">-</div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      loading-screen="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      embedded
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
      gesture-detector
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets timeout="10000">
        <a-asset-item id="animated-asset" src="eea/asset.glb"></a-asset-item>
        <video id="ding-video" src="eea/ding.mp4" preload="auto" muted></video>
        <audio id="page-flip-sound" src="eea/page-flip.mp3" preload="auto"></audio>
        <img id="cover" src="eea/cover.jpg">
        <img id="page2" src="eea/page2.jpg">
        <img id="page3" src="eea/page3.jpg">
      </a-assets>

      <a-marker
        id="animated-marker"
        type="pattern"
        preset="custom"
        url="eea/marker.patt"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
        gesture-handler
      >
        <!-- 3D模型 (初始縮小為0.3倍) -->
        <a-entity
          id="bowser-model"
          gltf-model="#animated-asset"
          animation-mixer="loop: repeat"
          scale="0.3 0.3 0.3"
          gesture-handler="minScale: 0.1; maxScale: 3"
          class="clickable"
        ></a-entity>

        <!-- 其他元素保持不變 -->
        <a-video id="video-entity" src="#ding-video" position="0 0.5 -0.5" scale="1 1 1" autoplay="false" muted></a-video>
        <a-plane id="book-page" position="0 1.5 -1" width="1.2" height="0.9" rotation="0 0 0" material="src: #cover; side: double" class="clickable"></a-plane>
        <a-image id="prev-button" src="eea/left-arrow.png" position="-0.8 1.5 -1" width="0.2" height="0.2" class="clickable"></a-image>
        <a-image id="next-button" src="eea/right-arrow.png" position="0.8 1.5 -1" width="0.2" height="0.2" class="clickable"></a-image>
      </a-marker>

      <a-entity camera cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-scene>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const pages = ['#cover', '#page2', '#page3'];
        let currentPage = 0;
        const flipSound = document.querySelector('#page-flip-sound');
        const model = document.querySelector('#bowser-model');

        // 縮放控制參數
        const ZOOM_FACTOR = 0.1;
        const MIN_SCALE = 0.1;
        const MAX_SCALE = 3.0;
        let currentScale = 0.3; // 初始縮放值

        // 初始化模型縮放
        model.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);

        // 翻頁功能
        function updateBookPage() {
          const page = document.querySelector("#book-page");
          if (page) {
            page.setAttribute('material', 'src', pages[currentPage]);
            // 添加翻頁動畫
            page.setAttribute('animation', {
              property: 'rotation',
              from: '0 0 0',
              to: '0 180 0',
              dur: 500,
              easing: 'easeInOutQuad'
            });
            setTimeout(() => {
              page.setAttribute('rotation', '0 0 0');
              page.removeAttribute('animation');
            }, 500);
          }
          if (flipSound) {
            flipSound.currentTime = 0;
            flipSound.play().catch(e => console.log("音效播放失敗:", e));
          }
        }

        // 翻頁按鈕
        document.querySelector('#prev-button').addEventListener('click', (e) => {
          e.stopPropagation();
          currentPage = (currentPage - 1 + pages.length) % pages.length;
          updateBookPage();
        });

        document.querySelector('#next-button').addEventListener('click', (e) => {
          e.stopPropagation();
          currentPage = (currentPage + 1) % pages.length;
          updateBookPage();
        });

        // 縮放控制功能
        document.querySelector('#zoom-in-btn').addEventListener('click', () => {
          currentScale = Math.min(currentScale + ZOOM_FACTOR, MAX_SCALE);
          model.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
        });

        document.querySelector('#zoom-out-btn').addEventListener('click', () => {
          currentScale = Math.max(currentScale - ZOOM_FACTOR, MIN_SCALE);
          model.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
        });

        // 影片控制
        const marker = document.querySelector('#animated-marker');
        const video = document.querySelector('#ding-video');
        
        marker.addEventListener('markerFound', () => {
          if (video) {
            video.play().catch(e => console.log("影片播放失敗:", e));
            video.muted = false;
          }
        });

        marker.addEventListener('markerLost', () => {
          if (video) {
            video.pause();
            video.currentTime = 0;
            video.muted = true;
          }
        });

        // 觸控滑動支援
        let touchStartX = 0;
        const sceneEl = document.querySelector('a-scene');

        sceneEl.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        sceneEl.addEventListener('touchend', (e) => {
          const touchEndX = e.changedTouches[0].screenX;
          const deltaX = touchEndX - touchStartX;

          if (Math.abs(deltaX) < 30) return;

          if (deltaX < 0) {
            currentPage = (currentPage + 1) % pages.length;
          } else {
            currentPage = (currentPage - 1 + pages.length) % pages.length;
          }
          updateBookPage();
        }, {passive: true});
      });
    </script>
  </body>
</html>
