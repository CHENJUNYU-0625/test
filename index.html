<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      loading-screen="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      embedded
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; disableDefaultDeviceOrientation: true"
      gesture-detector
    >
      <a-assets timeout="30000">
        <a-asset-item id="animated-asset" src="eea/asset.glb"></a-asset-item>
        <video id="ding-video" src="eea/ding.mp4" preload="auto" muted></video>
        <audio id="page-flip-sound" src="eea/page-flip.mp3" preload="auto"></audio>
        <img id="cover" src="eea/cover.jpg">
        <img id="page2" src="eea/page2.jpg">
        <img id="page3" src="eea/page3.jpg">
        <img id="zoom-in-img" src="eea/zoom-in.png">
        <img id="zoom-out-img" src="eea/zoom-out.png">
      </a-assets>

      <a-marker
        id="animated-marker"
        type="pattern"
        preset="custom"
        url="eea/marker.patt"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
        gesture-handler
      >
        <a-entity
          id="bowser-model"
          gltf-model="#animated-asset"
          animation-mixer="loop: repeat"
          scale="0.5 0.5 0.5"
          gesture-handler="minScale: 0.2; maxScale: 2"
          class="clickable"
        ></a-entity>

        <a-video
          id="video-entity"
          src="#ding-video"
          position="0 0.5 -0.5"
          scale="1 1 1"
          autoplay="false"
          muted
        ></a-video>

        <a-entity id="book-container" position="0 1.5 -1">
          <a-plane
            id="book-page-front"
            width="1.2"
            height="0.9"
            material="src: #cover; side: double"
            class="clickable"
          ></a-plane>
          <a-plane
            id="book-page-back"
            width="1.2"
            height="0.9"
            rotation="0 180 0"
            visible="false"
            material="side: double"
            class="clickable"
          ></a-plane>
        </a-entity>

        <a-image
          id="prev-button"
          src="eea/left-arrow.png"
          position="-0.8 1.5 -1"
          width="0.2"
          height="0.2"
          class="clickable"
        ></a-image>

        <a-image
          id="next-button"
          src="eea/right-arrow.png"
          position="0.8 1.5 -1"
          width="0.2"
          height="0.2"
          class="clickable"
        ></a-image>

        <a-image
          id="zoom-in-button"
          src="#zoom-in-img"
          position="0.8 1.8 -1"
          width="0.15"
          height="0.15"
          class="clickable"
        ></a-image>

        <a-image
          id="zoom-out-button"
          src="#zoom-out-img"
          position="0.8 2.0 -1"
          width="0.15"
          height="0.15"
          class="clickable"
        ></a-image>
      </a-marker>

      <a-entity camera cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-scene>

    <script>
      document.querySelector('a-scene').addEventListener('loaded', function() {
        initApp();
      });

      function initApp() {
        const pages = ['#cover', '#page2', '#page3'];
        let currentPage = 0;
        const flipSound = document.querySelector('#page-flip-sound');
        let isAnimating = false;

        function updateBookPage(direction) {
          if (isAnimating) return;
          isAnimating = true;

          const frontPage = document.querySelector("#book-page-front");
          const backPage = document.querySelector("#book-page-back");
          const nextPage = (currentPage + direction + pages.length) % pages.length;
          backPage.setAttribute('material', 'src', pages[nextPage]);

          const duration = 500;
          if (flipSound) {
            flipSound.currentTime = 0;
            flipSound.play().catch(e => console.log("Audio play failed:", e));
          }

          frontPage.removeAttribute('animation');
          backPage.removeAttribute('animation');

          frontPage.setAttribute('animation__flip', {
            property: 'rotation',
            to: `0 ${direction > 0 ? 180 : -180} 0`,
            dur: duration,
            easing: 'easeOutQuad'
          });

          setTimeout(() => {
            backPage.setAttribute('visible', 'true');
            backPage.setAttribute('animation__flip', {
              property: 'rotation',
              from: `0 ${direction > 0 ? -180 : 180} 0`,
              to: '0 0 0',
              dur: duration,
              easing: 'easeInQuad'
            });

            setTimeout(() => {
              frontPage.setAttribute('material', 'src', pages[nextPage]);
              frontPage.setAttribute('rotation', '0 0 0');
              backPage.setAttribute('visible', 'false');
              backPage.removeAttribute('animation__flip');
              frontPage.removeAttribute('animation__flip');
              currentPage = nextPage;
              isAnimating = false;
            }, duration);
          }, duration / 2);
        }

        function setupButtonListeners() {
          document.querySelector('#prev-button').addEventListener('click', (e) => {
            e.stopPropagation();
            updateBookPage(-1);
          });

          document.querySelector('#next-button').addEventListener('click', (e) => {
            e.stopPropagation();
            updateBookPage(1);
          });

          const model = document.querySelector('#bowser-model');
          const ZOOM_FACTOR = 0.1;
          const MIN_SCALE = 0.2;
          const MAX_SCALE = 2.0;

          document.querySelector('#zoom-in-button').addEventListener('click', (e) => {
            e.stopPropagation();
            const currentScale = model.getAttribute('scale');
            const newScale = {
              x: Math.min(currentScale.x + ZOOM_FACTOR, MAX_SCALE),
              y: Math.min(currentScale.y + ZOOM_FACTOR, MAX_SCALE),
              z: Math.min(currentScale.z + ZOOM_FACTOR, MAX_SCALE)
            };
            model.setAttribute('scale', newScale);
          });

          document.querySelector('#zoom-out-button').addEventListener('click', (e) => {
            e.stopPropagation();
            const currentScale = model.getAttribute('scale');
            const newScale = {
              x: Math.max(currentScale.x - ZOOM_FACTOR, MIN_SCALE),
              y: Math.max(currentScale.y - ZOOM_FACTOR, MIN_SCALE),
              z: Math.max(currentScale.z - ZOOM_FACTOR, MIN_SCALE)
            };
            model.setAttribute('scale', newScale);
          });
        }

        const marker = document.querySelector('#animated-marker');
        const video = document.querySelector('#ding-video');

        marker.addEventListener('markerFound', () => {
          console.log("Marker found");
          if (video) {
            video.play().catch(e => console.log("Video play failed:", e));
            video.muted = false;
          }

          document.querySelector('#book-page-front').setAttribute('rotation', '0 0 0');
          document.querySelector('#book-page-back').setAttribute('visible', 'false');
        });

        marker.addEventListener('markerLost', () => {
          console.log("Marker lost");
          if (video) {
            video.pause();
            video.currentTime = 0;
            video.muted = true;
          }
        });

        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartTime = 0;

        const sceneEl = document.querySelector('a-scene');

        sceneEl.addEventListener('touchstart', function (e) {
          touchStartX = e.changedTouches[0].screenX;
          touchStartTime = Date.now();
          e.preventDefault();
        }, {passive: false});

        sceneEl.addEventListener('touchend', function (e) {
          touchEndX = e.changedTouches[0].screenX;
          const deltaTime = Date.now() - touchStartTime;

          if (deltaTime < 500) {
            handleSwipeGesture();
          }
          e.preventDefault();
        }, {passive: false});

        function handleSwipeGesture() {
          const deltaX = touchEndX - touchStartX;
          if (Math.abs(deltaX) < 50) return;
          if (deltaX < 0) {
            updateBookPage(1);
          } else {
            updateBookPage(-1);
          }
        }

        setupButtonListeners();
      }
    </script>
  </body>
</html>
