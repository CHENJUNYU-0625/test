<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      loading-screen="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      embedded
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
      gesture-detector
    >
      <a-assets timeout="10000">
        <a-asset-item id="animated-asset" src="eea/asset.glb"></a-asset-item>
        <video id="ding-video" src="eea/ding.mp4" preload="auto" muted></video>
        <audio id="page-flip-sound" src="eea/page-flip.mp3" preload="auto"></audio>
        <img id="cover" src="eea/cover.jpg">
        <img id="page2" src="eea/page2.jpg">
        <img id="page3" src="eea/page3.jpg">
        <img id="zoom-in-img" src="eea/zoom-in.png">
        <img id="zoom-out-img" src="eea/zoom-out.png">
      </a-assets>

      <a-marker
        id="animated-marker"
        type="pattern"
        preset="custom"
        url="eea/marker.patt"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
        gesture-handler
      >
        <!-- 模型 (初始縮小為0.5倍) -->
        <a-entity
          id="bowser-model"
          gltf-model="#animated-asset"
          animation-mixer="loop: repeat"
          scale="0.5 0.5 0.5"
          gesture-handler="minScale: 0.2; maxScale: 2"
          class="clickable"
        ></a-entity>

        <!-- 影片 -->
        <a-video
          id="video-entity"
          src="#ding-video"
          position="0 0.5 -0.5"
          scale="1 1 1"
          autoplay
          muted
        ></a-video>

        <!-- 電子書頁面 -->
        <a-entity id="book-container" position="0 1.5 -1">
          <a-plane
            id="book-page-front"
            width="1.2"
            height="0.9"
            material="src: #cover"
            class="clickable"
          ></a-plane>
          <a-plane
            id="book-page-back"
            width="1.2"
            height="0.9"
            rotation="0 180 0"
            visible="false"
            class="clickable"
          ></a-plane>
        </a-entity>

        <!-- 翻頁按鈕 -->
        <a-image
          id="prev-button"
          src="eea/left-arrow.png"
          position="-0.8 1.5 -1"
          width="0.2"
          height="0.2"
          class="clickable"
        ></a-image>

        <a-image
          id="next-button"
          src="eea/right-arrow.png"
          position="0.8 1.5 -1"
          width="0.2"
          height="0.2"
          class="clickable"
        ></a-image>

        <!-- 縮放控制按鈕 -->
        <a-image
          id="zoom-in-button"
          src="#zoom-in-img"
          position="0.8 1.8 -1"
          width="0.15"
          height="0.15"
          class="clickable"
        ></a-image>

        <a-image
          id="zoom-out-button"
          src="#zoom-out-img"
          position="0.8 2.0 -1"
          width="0.15"
          height="0.15"
          class="clickable"
        ></a-image>
      </a-marker>

      <a-entity camera cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-scene>

    <script>
      const pages = [
        '#cover',
        '#page2',
        '#page3'
      ];
      let currentPage = 0;
      const flipSound = document.querySelector('#page-flip-sound');
      let isAnimating = false;

      function updateBookPage(direction) {
        if (isAnimating) return;
        isAnimating = true;
        
        const frontPage = document.querySelector("#book-page-front");
        const backPage = document.querySelector("#book-page-back");
        
        // 設置背面頁面的內容
        const nextPage = (currentPage + direction + pages.length) % pages.length;
        backPage.setAttribute('material', 'src', pages[nextPage]);
        
        // 動畫參數
        const duration = 500;
        const halfDuration = duration / 2;
        
        // 播放翻頁音效
        if (flipSound) {
          flipSound.currentTime = 0;
          flipSound.play();
        }
        
        // 第一步：翻轉前頁
        frontPage.setAttribute('animation', {
          property: 'rotation',
          to: `0 ${direction > 0 ? 180 : -180} 0`,
          dur: halfDuration,
          easing: 'easeOutQuad'
        });
        
        // 顯示背面頁面
        setTimeout(() => {
          backPage.setAttribute('visible', 'true');
          
          // 第二步：翻轉後頁
          backPage.setAttribute('animation', {
            property: 'rotation',
            from: `0 ${direction > 0 ? -180 : 180} 0`,
            to: '0 0 0',
            dur: halfDuration,
            easing: 'easeInQuad'
          });
          
          // 動畫完成後交換頁面
          setTimeout(() => {
            // 交換前後頁面
            frontPage.setAttribute('material', 'src', pages[nextPage]);
            frontPage.setAttribute('rotation', '0 0 0');
            backPage.setAttribute('visible', 'false');
            backPage.removeAttribute('animation');
            frontPage.removeAttribute('animation');
            
            currentPage = nextPage;
            isAnimating = false;
          }, halfDuration);
        }, halfDuration);
      }

      // 按鈕翻頁
      document.querySelector('#prev-button').addEventListener('click', () => {
        updateBookPage(-1);
      });

      document.querySelector('#next-button').addEventListener('click', () => {
        updateBookPage(1);
      });

      // 模型縮放控制
      const model = document.querySelector('#bowser-model');
      const ZOOM_FACTOR = 0.1;
      const MIN_SCALE = 0.2;
      const MAX_SCALE = 2.0;

      document.querySelector('#zoom-in-button').addEventListener('click', () => {
        const currentScale = model.getAttribute('scale');
        const newScale = {
          x: Math.min(currentScale.x + ZOOM_FACTOR, MAX_SCALE),
          y: Math.min(currentScale.y + ZOOM_FACTOR, MAX_SCALE),
          z: Math.min(currentScale.z + ZOOM_FACTOR, MAX_SCALE)
        };
        model.setAttribute('scale', newScale);
      });

      document.querySelector('#zoom-out-button').addEventListener('click', () => {
        const currentScale = model.getAttribute('scale');
        const newScale = {
          x: Math.max(currentScale.x - ZOOM_FACTOR, MIN_SCALE),
          y: Math.max(currentScale.y - ZOOM_FACTOR, MIN_SCALE),
          z: Math.max(currentScale.z - ZOOM_FACTOR, MIN_SCALE)
        };
        model.setAttribute('scale', newScale);
      });

      // 影片控制
      const marker = document.querySelector('#animated-marker');
      marker.addEventListener('markerFound', () => {
        const video = document.querySelector('#ding-video');
        if (video) {
          video.play();
          video.muted = false;
        }
      });

      marker.addEventListener('markerLost', () => {
        const video = document.querySelector('#ding-video');
        if (video) {
          video.pause();
          video.currentTime = 0;
          video.muted = true;
        }
      });

      // 觸控滑動支援
      let touchStartX = 0;
      let touchEndX = 0;

      const sceneEl = document.querySelector('a-scene');

      sceneEl.addEventListener('touchstart', function (e) {
        touchStartX = e.changedTouches[0].screenX;
      });

      sceneEl.addEventListener('touchend', function (e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipeGesture();
      });

      function handleSwipeGesture() {
        const deltaX = touchEndX - touchStartX;

        if (Math.abs(deltaX) < 30) return; // 忽略太短的滑動

        if (deltaX < 0) {
          // 向左滑動 → 下一頁
          updateBookPage(1);
        } else {
          // 向右滑動 → 上一頁
          updateBookPage(-1);
        }
      }
    </script>
  </body>
</html>
