<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 禁用不必要的權限請求 -->
    <meta name="vr-mode" content="no-vr-mode">
    <meta name="ar" content="no-ar">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      loading-screen="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      embedded
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
      gesture-detector
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets timeout="10000">
        <a-asset-item id="animated-asset" src="eea/asset.glb"></a-asset-item>
        <video id="ding-video" src="eea/ding.mp4" preload="auto" muted></video>
        <audio id="page-flip-sound" src="eea/page-flip.mp3" preload="auto"></audio>
        <img id="cover" src="eea/cover.jpg">
        <img id="page2" src="eea/page2.jpg">
        <img id="page3" src="eea/page3.jpg">
        <!-- 新增縮放按鈕圖標 -->
        <img id="zoom-in-icon" src="eea/zoom-in.png">
        <img id="zoom-out-icon" src="eea/zoom-out.png">
      </a-assets>

      <a-marker
        id="animated-marker"
        type="pattern"
        preset="custom"
        url="eea/marker.patt"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
        gesture-handler
      >
        <!-- 3D模型 (新增手勢縮放功能) -->
        <a-entity
          id="bowser-model"
          gltf-model="#animated-asset"
          animation-mixer="loop: repeat"
          scale="0.5 0.5 0.5"
          gesture-handler="minScale: 0.3; maxScale: 2"
          class="clickable"
        ></a-entity>

        <!-- 影片 -->
        <a-video
          id="video-entity"
          src="#ding-video"
          position="0 0.5 -0.5"
          scale="1 1 1"
          autoplay="false"
          muted
        ></a-video>

        <!-- 電子書頁面 -->
        <a-plane
          id="book-page"
          position="0 1.5 -1"
          width="1.2"
          height="0.9"
          rotation="0 0 0"
          material="src: #cover; side: double"
          class="clickable"
          animation__flip="property: rotation; dur: 500; startEvents: flip; from: 0 0 0; to: 0 180 0"
        ></a-plane>

        <!-- 翻頁按鈕 -->
        <a-image
          id="prev-button"
          src="eea/left-arrow.png"
          position="-0.8 1.5 -1"
          width="0.2"
          height="0.2"
          class="clickable"
        ></a-image>

        <a-image
          id="next-button"
          src="eea/right-arrow.png"
          position="0.8 1.5 -1"
          width="0.2"
          height="0.2"
          class="clickable"
        ></a-image>

        <!-- 新增縮放控制按鈕 -->
        <a-image
          id="zoom-in-button"
          src="#zoom-in-icon"
          position="0.8 1.8 -1"
          width="0.15"
          height="0.15"
          class="clickable"
        ></a-image>

        <a-image
          id="zoom-out-button"
          src="#zoom-out-icon"
          position="0.8 2.0 -1"
          width="0.15"
          height="0.15"
          class="clickable"
        ></a-image>
      </a-marker>

      <a-entity camera cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-scene>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const pages = ['#cover', '#page2', '#page3'];
        let currentPage = 0;
        const flipSound = document.querySelector('#page-flip-sound');
        const model = document.querySelector('#bowser-model');

        // 模型縮放參數
        const ZOOM_FACTOR = 0.1;
        const MIN_SCALE = 0.3;
        const MAX_SCALE = 2.0;

        function updateBookPage() {
          const page = document.querySelector("#book-page");
          if (page) {
            page.setAttribute('material', 'src', pages[currentPage]);
            page.emit('flip');
          }
          if (flipSound) {
            flipSound.currentTime = 0;
            flipSound.play().catch(e => console.log("音效播放失敗:", e));
          }
        }

        // 按鈕翻頁
        document.querySelector('#prev-button').addEventListener('click', (e) => {
          e.stopPropagation();
          currentPage = (currentPage - 1 + pages.length) % pages.length;
          updateBookPage();
        });

        document.querySelector('#next-button').addEventListener('click', (e) => {
          e.stopPropagation();
          currentPage = (currentPage + 1) % pages.length;
          updateBookPage();
        });

        // 新增模型縮放控制
        document.querySelector('#zoom-in-button').addEventListener('click', (e) => {
          e.stopPropagation();
          const currentScale = model.getAttribute('scale');
          const newScale = {
            x: Math.min(currentScale.x + ZOOM_FACTOR, MAX_SCALE),
            y: Math.min(currentScale.y + ZOOM_FACTOR, MAX_SCALE),
            z: Math.min(currentScale.z + ZOOM_FACTOR, MAX_SCALE)
          };
          model.setAttribute('scale', newScale);
        });

        document.querySelector('#zoom-out-button').addEventListener('click', (e) => {
          e.stopPropagation();
          const currentScale = model.getAttribute('scale');
          const newScale = {
            x: Math.max(currentScale.x - ZOOM_FACTOR, MIN_SCALE),
            y: Math.max(currentScale.y - ZOOM_FACTOR, MIN_SCALE),
            z: Math.max(currentScale.z - ZOOM_FACTOR, MIN_SCALE)
          };
          model.setAttribute('scale', newScale);
        });

        // 影片控制
        const marker = document.querySelector('#animated-marker');
        const video = document.querySelector('#ding-video');
        
        marker.addEventListener('markerFound', () => {
          if (video) {
            video.play().catch(e => console.log("影片播放失敗:", e));
            video.muted = false;
          }
        });

        marker.addEventListener('markerLost', () => {
          if (video) {
            video.pause();
            video.currentTime = 0;
            video.muted = true;
          }
        });

        // 觸控滑動支援
        let touchStartX = 0;
        const sceneEl = document.querySelector('a-scene');

        sceneEl.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        sceneEl.addEventListener('touchend', (e) => {
          const touchEndX = e.changedTouches[0].screenX;
          const deltaX = touchEndX - touchStartX;

          if (Math.abs(deltaX) < 30) return;

          if (deltaX < 0) {
            currentPage = (currentPage + 1) % pages.length;
          } else {
            currentPage = (currentPage - 1 + pages.length) % pages.length;
          }
          updateBookPage();
        }, {passive: true});
      });
    </script>
  </body>
</html>
